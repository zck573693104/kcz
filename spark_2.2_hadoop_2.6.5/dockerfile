FROM centos:centos6.6
MAINTAINER zck
RUN yum install -y wget \
 && wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo \
 && yum clean all \
 && yum makecache \
 && yum -y update \
 && wget http://repo.mysql.com/mysql-community-release-el6-5.noarch.rpm \
 && yum localinstall -y mysql-community-release-el6-5.noarch.rpm \
 && yum install -y mysql-community-server \
 && yum install -y unzip python3 python3-setuptools  \
 && yum install -y net-tools \
 && yum -y install bzip2 zip gzip\
 && yum install -y tar \
 && yum install -y vim curl openssh-server openssh-clients \
 && ssh-keygen -q -t rsa -b 2048 -f /etc/ssh/ssh_host_rsa_key -N '' \
 && ssh-keygen -f /root/.ssh/id_rsa -N '' \
 && touch /root/.ssh/authorized_keys \
 && cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys \
 && sed -i 's/#PermitRootLogin  without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config \
 && sed -i 's/#   StrictHostKeyChecking ask/StrictHostKeyChecking no/g' /etc/ssh/ssh_config \
 && echo "root:123456" | chpasswd \	
 && rm -rf /var/lib/apt/lists/* \
 && rm -rf /etc/my.cnf

COPY bootstrap.sh /etc/bootstrap.sh
COPY mysql_init.sql /usr/local
COPY mysql.sh /usr/local
COPY my.cnf /etc
RUN chown root.root /etc/bootstrap.sh \
 && chmod 700 /etc/bootstrap.sh \
 && chmod 700 /usr/local/mysql.sh
ADD jdk-8u191-linux-x64.tar.gz /usr/java/
ADD spark-2.2.2-bin-hadoop2.6.tgz /usr/local/
ADD hadoop-2.6.5.tar.gz /usr/local
ADD zookeeper-3.4.13.tar.gz /usr/local
ADD kafka_2.11-2.1.0.tgz /usr/local
ADD apache-hive-2.3.4-bin.tar.gz /usr/local
RUN mv /usr/local/apache-hive-2.3.4-bin/ /usr/local/hive-2.3.4/
# http://blog.stuart.axelbrooke.com/python-3-on-spark-return-of-the-pythonhashseed
ENV PYTHONHASHSEED 0
ENV PYTHONIOENCODING UTF-8
ENV PIP_DISABLE_PIP_VERSION_CHECK 1

# JAVA
ARG JAVA_MAJOR_VERSION=8
ARG JAVA_UPDATE_VERSION=191
ARG JAVA_BUILD_NUMBER=12
ENV JAVA_HOME /usr/java/jdk1.${JAVA_MAJOR_VERSION}.0_${JAVA_UPDATE_VERSION}
ENV PATH $PATH:$JAVA_HOME/bin
# ZK KAFKA
ENV ZOOKEEPER_HOME=/usr/local/zookeeper-3.4.13
ENV PATH=$PATH:$ZOOKEEPER_HOME/bin
ENV KAFKA_HOME=/usr/local/kafka_2.11-2.1.0
ENV PATH=$PATH:$KAFKA_HOME/bin
# HADOOP
ENV HADOOP_VERSION 2.6.5
ENV HADOOP_HOME /usr/local/hadoop-$HADOOP_VERSION
ENV HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
ENV HADOOP_COMMON_HOME=$HADOOP_HOME
ENV PATH $PATH:$HADOOP_HOME/bin

#HIVE
ENV HIVE_VERSION 2.3.4
ENV HIVE_HOME /usr/local/hive-$HIVE_VERSION
ENV HIVE_COMMON_HOME=$HIVE_HOME
ENV PATH $PATH:$HIVE_HOME/bin

# SPARK
ENV SPARK_VERSION 2.2.2-bin-hadoop2.6
ENV SPARK_PACKAGE spark-${SPARK_VERSION}-bin-without-hadoop
ENV SPARK_HOME /usr/local/spark-${SPARK_VERSION}
ENV SPARK_DIST_CLASSPATH="$HADOOP_HOME/etc/hadoop/*:$HADOOP_HOME/share/hadoop/common/lib/*:$HADOOP_HOME/share/hadoop/common/*:$HADOOP_HOME/share/hadoop/hdfs/*:$HADOOP_HOME/share/hadoop/hdfs/lib/*:$HADOOP_HOME/share/hadoop/hdfs/*:$HADOOP_HOME/share/hadoop/yarn/lib/*:$HADOOP_HOME/share/hadoop/yarn/*:$HADOOP_HOME/share/hadoop/mapreduce/lib/*:$HADOOP_HOME/share/hadoop/mapreduce/*:$HADOOP_HOME/share/hadoop/tools/lib/*"
ENV PATH $PATH:${SPARK_HOME}/bin

RUN  rm $HADOOP_HOME/etc/hadoop/hadoop-env.sh \
 &&	rm $HADOOP_HOME/etc/hadoop/yarn-env.sh \
 &&	rm $HADOOP_HOME/etc/hadoop/core-site.xml \
 &&	rm $HADOOP_HOME/etc/hadoop/hdfs-site.xml \
 &&	rm $HADOOP_HOME/etc/hadoop/yarn-site.xml \
 &&	rm $HADOOP_HOME/etc/hadoop/slaves \
 && rm $SPARK_HOME/sbin/spark-config.sh \
 && sed -i 's/localhost/master/g' /usr/local/kafka_2.11-2.1.0/config/server.properties
COPY hive-site.xml $HIVE_COMMON_HOME/conf/
COPY hive-env.sh $HIVE_COMMON_HOME/conf/
COPY hive-log4j2.properties $HIVE_COMMON_HOME/conf/
COPY core-site.xml $HADOOP_HOME/etc/hadoop/
COPY hdfs-site.xml $HADOOP_HOME/etc/hadoop/
COPY hadoop-env.sh $HADOOP_HOME/etc/hadoop/
COPY yarn-env.sh $HADOOP_HOME/etc/hadoop/
COPY slaves $HADOOP_HOME/etc/hadoop/
COPY mapred-site.xml $HADOOP_HOME/etc/hadoop/
COPY yarn-site.xml $HADOOP_HOME/etc/hadoop/
COPY spark-env.sh $SPARK_HOME/conf/
COPY run.sh /usr/local/
COPY initRun.sh /usr/local/
COPY zoo.cfg $ZOOKEEPER_HOME/conf/
COPY KafkaOffsetMonitor-assembly-0.2.0.jar $KAFKA_HOME
COPY kafka-monitor-start.sh $KAFKA_HOME
COPY mysql-connector-java-5.1.35.jar $HIVE_HOME/lib
WORKDIR $SPARK_HOME
CMD ["bin/spark-class", "org.apache.spark.deploy.master.Master"]
ENTRYPOINT ["/etc/bootstrap.sh"]